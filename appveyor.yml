version: '{build}'

image: Visual Studio 2017

environment:
#  DOCKER_USER: idubnori
#  DOCKER_PASS:
#    secure: HASfuLeqW86zydzpb7/5Zg==
  DOCKER_IMAGE_NAME: idubnori/rabbitmq-windows:3.6.9
#$(APPVEYOR_REPO_BRANCH)-$(APPVEYOR_BUILD_NUMBER)

init:
  - ps: gcim Win32_Processor | % { "$($_.NumberOfCores) cores" }
  - ps: gcim Win32_OperatingSystem | % { "$([int]($_.TotalVisibleMemorySize/1mb)) Gb" }
  - ps: docker version
  - ps: docker info
  - ps: docker images
  - ps: |
      cinst curl -y
      sal curl (Join-Path $env:ChocolateyInstall "bin\curl.exe") -O AllScope
      gal curl
      curl "http://google.com" -s --retry 10

build_script:
  - ps: |
      cd $env:APPVEYOR_BUILD_FOLDER
      cd .\rabbitmq\windows\3.6.9\
      docker build -t $env:DOCKER_IMAGE_NAME .
      docker images

test_script:
  - ps: |
      $cid = docker run -d $env:DOCKER_IMAGE_NAME
      $hostip = docker inspect -f "{{ .NetworkSettings.Networks.nat.IPAddress }}" $cid
      echo "hostip:${hostip}"
      curl "http://${hostip}:15672" --retry 10

deploy_script:
#  - docker login -u %DOCKER_USER% -p %DOCKER_PASS%
#  - docker push %DOCKER_IMAGE_NAME%